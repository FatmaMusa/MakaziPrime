<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properties - MakaziPrime Admin</title>
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Additional page-specific styles if needed */
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header"><i class="fas fa-building" style="margin-right: 10px;"></i> MakaziPrime</div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="admin.html"><i class="fas fa-th-large"></i> Dashboard</a></li>
                <li><a href="admin_properties.html" class="active"><i class="fas fa-home"></i> Properties</a></li>
                <li><a href="admin_bookings.html"><i class="fas fa-calendar-check"></i> Bookings</a></li>
                <li><a href="admin_viewings.html"><i class="fas fa-calendar-alt"></i> Viewings</a></li>
                <li><a href="admin_users.html"><i class="fas fa-users"></i> Users</a></li>
                <li><a href="admin_logs.html"><i class="fas fa-clipboard-list"></i> Logs</a></li>
            </ul>
        </nav>
        <div class="sidebar-user">
            <div>Logged in as: <br><strong id="adminName">Loading...</strong></div>
            <a href="#" onclick="logout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h1 class="page-title">Property Management</h1>
            <button onclick="openModal()" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> <span>Add New
                    Property</span></button>
        </header>

        <div class="content-wrapper">
            <div class="data-table-container">
                <table id="propertiesTable">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Price (Tsh)</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS renders -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Add/Edit Modal -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="margin-bottom: 20px;">Add Property</h2>
            <form id="propertyForm" enctype="multipart/form-data">
                <input type="hidden" id="propId" name="property_id">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" id="title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select name="type_id" id="type_id" class="form-control" required>
                            <option value="1">Apartment</option>
                            <option value="2">Villa</option>
                            <option value="3">Office</option>
                            <option value="4">Land</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Listing Type</label>
                        <select name="listing_type" id="listing_type" class="form-control" required
                            onchange="toggleRentPeriod()">
                            <option value="sale">For Sale</option>
                            <option value="rent">For Rent</option>
                        </select>
                    </div>
                    <div class="form-group" id="rentPeriodGroup" style="display:none;">
                        <label class="form-label">Rent Period</label>
                        <select name="rent_period" id="rent_period" class="form-control">
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                            <option value="daily">Daily</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Price</label>
                        <input type="number" name="price" id="price" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" name="location" id="location" class="form-control" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bedrooms</label>
                        <input type="number" name="bedrooms" id="bedrooms" class="form-control" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bathrooms</label>
                        <input type="number" name="bathrooms" id="bathrooms" class="form-control" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area (Sqft)</label>
                        <input type="number" name="area_sqft" id="area_sqft" class="form-control" value="0">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" id="description" class="form-control" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select name="status" id="status" class="form-control">
                        <option value="available">Available</option>
                        <option value="sold">Sold</option>
                        <option value="reserved">Reserved</option>
                        <option value="rented">Rented</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Image</label>
                    <input type="file" name="image" id="image" class="form-control" accept="image/*">
                    <small>Leave empty to keep current image when editing.</small>
                </div>

                <div class="form-group" style="text-align: right;">
                    <button type="submit" class="btn btn-primary">Save Property</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../assets/js/admin.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadProperties);

        async function loadProperties() {
            const data = await fetchAPI('properties/read_admin.php');
            const tbody = document.querySelector('#propertiesTable tbody');
            tbody.innerHTML = '';

            data.forEach(prop => {
                const tr = document.createElement('tr');
                const listingBadge = prop.listing_type === 'rent'
                    ? '<span class="badge badge-info">For Rent</span>'
                    : '<span class="badge badge-success">For Sale</span>';
                const priceLabel = prop.listing_type === 'rent'
                    ? `Tsh ${new Intl.NumberFormat().format(prop.price)}/${prop.rent_period || 'month'}`
                    : `Tsh ${new Intl.NumberFormat().format(prop.price)}`;
                tr.innerHTML = `
                    <td><img src="../${prop.image_url}" alt="img" style="width:50px; height:50px; object-fit:cover; border-radius:4px;"></td>
                    <td>${prop.title}<br>${listingBadge}</td>
                    <td>${prop.type_name}</td>
                    <td>${priceLabel}</td>
                    <td>${prop.location}</td>
                    <td>${getStatusBadge(prop.status)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick='editProperty(${JSON.stringify(prop)})'><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProperty(${prop.property_id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        const modal = document.getElementById('propertyModal');
        const form = document.getElementById('propertyForm');

        function openModal() {
            modal.style.display = "block";
            document.getElementById('modalTitle').textContent = "Add Property";
            form.reset();
            document.getElementById('propId').value = "";
            document.getElementById('listing_type').value = "sale";
            toggleRentPeriod();
        }

        function closeModal() {
            modal.style.display = "none";
        }

        function toggleRentPeriod() {
            const listingType = document.getElementById('listing_type').value;
            const rentPeriodGroup = document.getElementById('rentPeriodGroup');
            rentPeriodGroup.style.display = listingType === 'rent' ? 'block' : 'none';
        }

        window.onclick = function (event) {
            if (event.target == modal) closeModal();
        }

        function editProperty(prop) {
            openModal();
            document.getElementById('modalTitle').textContent = "Edit Property";
            document.getElementById('propId').value = prop.property_id;
            document.getElementById('title').value = prop.title;
            document.getElementById('type_id').value = prop.type_id;
            document.getElementById('listing_type').value = prop.listing_type || 'sale';
            toggleRentPeriod();
            if (prop.rent_period) {
                document.getElementById('rent_period').value = prop.rent_period;
            }
            document.getElementById('price').value = prop.price;
            document.getElementById('location').value = prop.location;
            document.getElementById('bedrooms').value = prop.bedrooms;
            document.getElementById('bathrooms').value = prop.bathrooms;
            document.getElementById('area_sqft').value = prop.area_sqft;
            document.getElementById('description').value = prop.description;
            document.getElementById('status').value = prop.status;
        }

        async function deleteProperty(id) {
            showConfirmModal("Are you sure you want to delete this property?", async () => {
                const res = await fetchAPI('properties/delete.php', 'POST', { property_id: id });
                if (res.message) {
                    alert(res.message);
                    loadProperties();
                }
            });
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const id = document.getElementById('propId').value;
            const endpoint = id ? 'properties/update.php' : 'properties/create.php';

            try {
                const res = await fetch(`../api/${endpoint}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();

                if (res.ok) {
                    alert(result.message);
                    closeModal();
                    loadProperties();
                } else {
                    alert(result.message || "Error occurred");
                }
            } catch (error) {
                console.error(error);
                alert("Request failed.");
            }
        };
    </script>
</body>

</html>